<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>SQLite on iOS: The MVVM Way</title>
    <meta name="description"
        content="">
    <link rel="canonical" href="https://mattrighetti.github.io/2022/03/02/use-sqlite-in-ios.html">
    <link rel="alternate" type="application/rss+xml" title="mattrighetti"
        href="https://mattrighetti.github.io/feed.xml">

    <link rel="stylesheet" href=" /css/font.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href=" /css/style.css">
    <link rel="stylesheet" href=" /css/code.css">
</head>

<body class="mx-auto max-width">
    <header class="mx-auto site-header">
        <nav>
            <a class="-title" href="/">mattrighetti</a>
            
            
            
            
            
            
            
            <a href="/about.html">About</a>
            
            
            
            
            
            
            
            
            
            <a href="/projects.html">Projects</a>
            
            
            
            
            
            <a href="/resume.html">Resume</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </nav>
    </header>

    <main>
        <article>
  <h1>SQLite on iOS: The MVVM Way</h1>
  <div class="post-meta sect1">Mar 2, 2022</div>
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fdownload.logo.wine%2Flogo%2FSQLite%2FSQLite-Logo.wine.png&amp;f=1&amp;nofb=1" alt="?u=https%3A%2F%2Fdownload.logo.wine%2Flogo%2FSQLite%2FSQLite Logo.wine"></span></p>
</div>
<div class="paragraph">
<p>Last week I was studying
<a href="https://github.com/Ranchero-Software/NetNewsWire">NetNewsWire</a>
to see if I could find something interesting
to implement in my projects.</p>
</div>
<div class="paragraph">
<p>A cool thing that I’ve found is that the project does not use CoreData,
instead it makes use of SQLite. The project’s author explained on the
Sundell podcast episode #95 some good points on why adopting SQLite has
improved performance greatly.</p>
</div>
<div class="paragraph">
<p>Sometimes you may want something more from your data storage, you want
more control, or you just want to work with tables and SQL lite statements.</p>
</div>
<div class="paragraph">
<p>I wanted to try this because I don&#8217;t have a good relationship with CoreData
and CloudKit integration, I HATE GUIs and also because I work a lot on backend
services so I prefer to work with the data layer and optimize indexing and queryies
myself and having them written down.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introducing-fmdb">Introducing FMDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/ccgus/fmdb">FMDB</a> is an Objective-C wrapper around SQLite,
it&#8217;s open source and it&#8217;s really easy to setup and it happens to be the only
good library that lets you do that (I may be wrong here, if you know other
good libraries please let me know, I would love to try them out!)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setup">Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s create a new Xcode project, I&#8217;ll call mine SQLiteIntro.</p>
</div>
<div class="paragraph">
<p>This app is not going to be really complex as I just want to give a
little introduction to the topic, just the right amount to give you an idea
on how working with SQL looks like in a swift project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="datawrapper">DataWrapper</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s good practice to separate logic in its dedicated class/struct. In this case,
since we&#8217;re working with an SQL database I want to create a class that will abstract
a bit of data layer logic so that code will be a lot cleaner going forward.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="swift"><span class="kd">final</span> <span class="kd">class</span> <span class="kt">DataWrapper</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">FMDatabase</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">fileName</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"test"</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 1 - Get filePath of the SQLite file</span>
        <span class="k">let</span> <span class="nv">fileURL</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">FileManager</span><span class="o">.</span><span class="k">default</span>
            <span class="o">.</span><span class="nf">url</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="n">applicationSupportDirectory</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">userDomainMask</span><span class="p">,</span> <span class="nv">appropriateFor</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">create</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">appendingPathComponent</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">fileName</span><span class="se">)</span><span class="s">.sqlite"</span><span class="p">)</span>

        <span class="c1">// 2 - Create FMDatabase from filePath</span>
        <span class="k">let</span> <span class="nv">db</span> <span class="o">=</span> <span class="kt">FMDatabase</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">fileURL</span><span class="p">)</span>

        <span class="c1">// 3 - Open connection to database</span>
        <span class="k">guard</span> <span class="n">db</span><span class="o">.</span><span class="nf">open</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Unable to open database"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">// 4 - Initial table creation</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">executeUpdate</span><span class="p">(</span><span class="s">"create table if not exists users(username varchar(255) primary key, age integer)"</span><span class="p">,</span> <span class="nv">values</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">(</span><span class="s">"cannot execute query"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is all you need to start, simple right?</p>
</div>
<div class="paragraph">
<p>The code is straightforward: when the DataWrapper class
is initially created it will look for the database file, if the file is not
present FMDB will create a database for you with that path.
Finally it opens a connection to the database and creates the <code>user</code> table.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="model">Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To work with the database records I want to create a <code>User</code> struct,
in my example I&#8217;m going to include some other JSON related stuff because
I&#8217;m going to use it later to create users with random name using some web APIs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="swift"><span class="kd">struct</span> <span class="kt">User</span><span class="p">:</span> <span class="kt">Hashable</span><span class="p">,</span> <span class="kt">Decodable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">username</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">age</span><span class="p">:</span> <span class="kt">Int</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">username</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">age</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="k">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="p">}</span>

    <span class="nf">init</span><span class="p">?(</span><span class="n">from</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">FMResultSet</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">username</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="nf">string</span><span class="p">(</span><span class="nv">forColumn</span><span class="p">:</span> <span class="s">"username"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
            <span class="k">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="kt">Int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="nf">int</span><span class="p">(</span><span class="nv">forColumn</span><span class="p">:</span> <span class="s">"age"</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">enum</span> <span class="kt">CodingKeys</span> <span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">CodingKey</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"first_name"</span>
    <span class="p">}</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">from</span> <span class="nv">decoder</span><span class="p">:</span> <span class="kt">Decoder</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">container</span><span class="p">(</span><span class="nv">keyedBy</span><span class="p">:</span> <span class="kt">CodingKeys</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="k">try</span> <span class="n">container</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">String</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="n">age</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="nf">random</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="mi">1</span><span class="o">..&lt;</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>FMResultSet</code> is what you will always get when you execute a query from the database,
even if you expect a single record, or an empty result, that&#8217;s why it&#8217;s useful to have
a dedicated init function to handle all the setup logic in this case.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="combine-and-mvvm">Combine and MVVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since I&#8217;m using SwiftUI I&#8217;d like the <code>DataWrapper</code> to be reactive and notify
the view of possible changes in the database.
Going back to the implementation of <code>DataWrapper</code>,
I&#8217;m adding a <code>@Published</code> array of users so that I can display
them in a <code>List</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="swift"><span class="kd">final</span> <span class="kd">class</span> <span class="kt">DataWrapper</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">FMDatabase</span>

    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">users</span> <span class="o">=</span> <span class="p">[</span><span class="kt">User</span><span class="p">]()</span>

    <span class="o">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To fetch users from the database and publish them as soon as the database is opend
we need to create a method to query all users and set them to DataWrapper&#8217;s users
variable after the database initialization.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="swift"><span class="kd">func</span> <span class="nf">getAllUsers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">User</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">users</span> <span class="o">=</span> <span class="p">[</span><span class="kt">User</span><span class="p">]()</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">executeQuery</span><span class="p">(</span><span class="s">"select username, age from users"</span><span class="p">,</span> <span class="nv">values</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">result</span><span class="o">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="kt">User</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">users</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">users</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">users</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and place this call at the bottom of the <code>init</code> method of <code>DataWrapper</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="swift"><span class="n">users</span> <span class="o">=</span> <span class="nf">getAllUsers</span><span class="p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when you first fire <code>DataWrapper</code> it will automatically
fetch all the users and they will be ready to be used in SwiftUI.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll create an <code>insert</code> function that I&#8217;m going to use later</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="swift"><span class="kd">func</span> <span class="nf">insert</span><span class="p">(</span><span class="n">_</span> <span class="nv">user</span><span class="p">:</span> <span class="kt">User</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">db</span><span class="o">.</span><span class="nf">executeUpdate</span><span class="p">(</span>
            <span class="s">"""
            insert into users (username, age)
            values (?, ?)
            """</span><span class="p">,</span>
            <span class="nv">values</span><span class="p">:</span> <span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">users</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nf">fatalError</span><span class="p">(</span><span class="s">"cannot insert user: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="a-quick-swiftui-view">A Quick SwiftUI View</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I want to create a <code>List</code> that displays all the users that the database contains
and also create a simple function that queries a web API to get a random username
and inserts a new user into the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="swift"><span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@EnvironmentObject</span> <span class="k">var</span> <span class="nv">db</span><span class="p">:</span> <span class="kt">DataWrapper</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">NavigationView</span> <span class="p">{</span>
            <span class="kt">List</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">user</span> <span class="k">in</span>
                <span class="kt">HStack</span> <span class="p">{</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
                    <span class="kt">Spacer</span><span class="p">()</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">age</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="o">.</span><span class="nf">navigationTitle</span><span class="p">(</span><span class="s">"Users"</span><span class="p">)</span>
            <span class="o">.</span><span class="n">toolbar</span> <span class="p">{</span>
                <span class="kt">ToolbarItem</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="s">"plus"</span><span class="p">,</span> <span class="nv">placement</span><span class="p">:</span> <span class="o">.</span><span class="n">navigationBarTrailing</span><span class="p">,</span> <span class="nv">showsByDefault</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">Button</span><span class="p">(</span><span class="nv">action</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nf">createRandomUser</span><span class="p">()</span>
                    <span class="p">},</span> <span class="nv">label</span><span class="p">:</span> <span class="p">{</span>
                        <span class="kt">Image</span><span class="p">(</span><span class="nv">systemName</span><span class="p">:</span> <span class="s">"plus"</span><span class="p">)</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">createRandomUser</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://random-data-api.com/api/name/random_name"</span><span class="p">)</span><span class="o">!</span>
        <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">fatalError</span><span class="p">(</span><span class="s">"No data"</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">JSONDecoder</span><span class="p">()</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">User</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run your app now, you will be presented with an empty
list, but if you press the plus button you will start to
insert stuff in the database and names will begin to appear
reactively in your list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://media.giphy.com/media/bBV1Sbs5soDaEuqQh0/giphy.gif" alt="giphy"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This was a very simple scenario that might now show a huge
boot in performance with respect to the CoreData version, but
it&#8217;s a different way to store data in a more familiar SQLite database.</p>
</div>
<div class="paragraph">
<p>If you want more control over your data, SQLite and the power of SQL
will certainly not let you down. SQLite could improve
performance in applications that need fine grained control
and aimed query optimizations. It&#8217;s also easier to sync data
with CloudKit since now you just have to sync the sqlite file
without dealing with all the CoreData tables and different versions.</p>
</div>
<div class="paragraph">
<p>I&#8217;m working on an article that talks about migration strategies with SQLite,
so if you want to know more stay tuned!</p>
</div>
</div>
</div>
</article>
<script>
    function renderCodeTags() {
        const collection = document.getElementsByClassName("rouge highlight");

        for (let i = 0; i < collection.length; i++) {
        let cNode = collection[i].firstChild;
        let lang = cNode.getAttribute("data-lang");
        
        let newNode = document.createElement("div");
        newNode.className = "lang-tag";
        newNode.innerHTML += lang;
        
        collection[i].insertBefore(newNode, cNode);
        }
    }

    renderCodeTags()
</script>
    </main>

    <footer class="site-footer">
        <p>
            <a href=" /feed.xml">
                <i class="fa fa-rss"></i> rss
            </a>

            <a href="https://github.com/mattrighetti">
                <i class="fa fa-github"></i> mattrighetti
            </a>
        </p>
    </footer>

</body>

</html>