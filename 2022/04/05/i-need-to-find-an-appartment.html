<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>I Need To Find An Appartment</title>
    <meta name="description"
        content="Long story short: I&#8217;ve taken a new position in Luxembourg and I have tofind an apartment, in a different country, in a reasonably short time.">
    <link rel="canonical" href="https://mattrighetti.github.io/2022/04/05/i-need-to-find-an-appartment.html">
    <link rel="alternate" type="application/rss+xml" title="mattrighetti"
        href="https://mattrighetti.github.io/feed.xml">

    <link rel="stylesheet" href=" /css/font.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href=" /css/style.css">
    <link rel="stylesheet" href=" /css/code.css">
</head>

<body class="mx-auto max-width">
    <header class="mx-auto site-header">
        <nav>
            <a class="-title" href="/">mattrighetti</a>
            
            
            
            
            
            
            
            <a href="/about.html">About</a>
            
            
            
            
            
            
            
            
            
            <a href="/projects.html">Projects</a>
            
            
            
            
            
            <a href="/resume.html">Resume</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </nav>
    </header>

    <main>
        <article>
  <h1>I Need To Find An Appartment</h1>
  <div class="post-meta sect1">Apr 5, 2022</div>
  <div class="paragraph">
<p>Long story short: I&#8217;ve taken a new position in Luxembourg and I have to
find an apartment, in a different country, in a reasonably short time.</p>
</div>
<div class="openblock note">
<div class="content">
<div class="paragraph">
<p><strong>TL;DR:</strong> I hate apartment hunting, I&#8217;ve tried to make it as interesting
as possible by creating a pipeline with different tools and languages
to <em>scrape</em> data from a website with the use of Puppeteer, load data into
a SQLite database using Go and visualizing all the data with Python and Folium.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you want to look at the final code or follow along with me
you can checkout the project repo on
<a href="https://github.com/mattrighetti/athome-scraper">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>I initially sketched what I was looking for by priority</p>
</div>
<div class="imageblock">
<div class="content">
<svg preserveAspectRatio="xMidYMid meet" viewBox="0 0 700 571" xmlns="http://www.w3.org/2000/svg" width="500"><g transform="matrix(.1 0 0 -.1 0 571)"><path d="m1092 4878c-5-7-17-40-27-73-22-76-52-135-109-212-28-39-53-63-65-63-27 0-44-26-37-55 6-23 21-30 55-25 17 2 51 42 120 139l53 76-5-275c-3-151-11-291-17-311-14-49 1-92 32-87 14 2 25 13 30 33 12 40 26 825 16 848-10 20-31 22-46 5z"/><path d="m2167 4779c-110-26-183-116-124-153 22-14 51 3 55 33 4 27 39 50 92 62 62 14 120-15 149-73 32-66 28-87-26-140-58-55-85-70-129-70-52 0-65 16-62 76 3 48 2 51-21 51-19 0-27-7-34-30-13-44-25-467-14-482 28-37 89 5 67 46-5 11-10 78-10 149v128h63c80 0 128 25 196 101 45 51 51 63 51 103-1 83-54 162-132 194-41 18-64 18-121 5z"/><path d="m3850 4597c-32-14-67-21-117-21-98-2-113-16-83-77 19-41 21-54 14-169-8-158 4-228 47-264 55-47 140-43 188 8 39 41 1 76-45 41-21-16-81-20-102-6-28 17-43 150-19 168 6 6 31 13 54 17 66 10 114 36 111 61-3 23-42 33-62 16-7-6-34-14-60-17l-46-7v66c0 70 14 97 50 97 32 0 126 39 145 60 15 16 15 22 5 35-16 19-25 18-80-8z"/><path d="m2990 4595c-17-20-29-141-29-292-1-67-6-144-13-172-13-59-1-84 41-79 26 3 26 4 28 103 2 55 7 176 12 270 8 129 7 171-2 177-17 11-23 10-37-7z"/><path d="m3374 4590c-63-25-125-193-126-341-3-218 133-302 256-157 40 46 43 59 20 79-13 11-22 6-61-34-49-51-85-66-107-48-74 62-54 336 31 433 21 23 43 11 43-23 0-35 30-55 60-39 40 22 11 102-45 126-39 16-42 16-71 4z"/><path d="m2502 4529c-73-36-90-60-68-94 15-23 15-37 1-328-4-83-3-89 18-96 12-5 29-5 39 0 14 8 16 24 11 126l-4 118 49 23c59 26 103 28 124 5 27-31 55-96 61-142 6-51 25-75 51-65 45 17-24 226-87 265-18 10-36 20-41 22s1 22 13 45c30 59 25 119-13 144-26 17-95 7-154-23zm128-51c0-33-48-108-76-119-41-15-44-12-44 49 0 51 3 60 23 70 60 29 97 29 97 0z"/><path d="m1264 4052c-40-27-7-100 38-83 32 12 36 54 6 75-25 18-29 19-44 8z"/><path d="m1906 3895c-19-19-21-51-3-62 6-4 44-8 82-9 39-1 196-11 350-23 562-42 724-51 943-51 141 0 222-4 222-10 0-13 46-13 71 0 22 12 25 43 7 58-8 6-150 12-353 15-187 3-396 10-465 16-200 17-242 20-490 37-215 14-264 20-326 39-13 4-27 1-38-10z"/><path d="m1878 3794c-20-6-31-34-23-56 7-17 60-32 76-22 5 3 182-6 392-20 210-13 506-30 657-36s311-15 355-20 117-9 162-9c45-1 85-5 88-11 9-14 58-13 73 2 17 17 15 46-5 56-10 5-90 12-178 16-88 3-207 10-265 16-58 5-233 14-390 20-346 12-802 44-900 63-14 3-33 3-42 1z"/><path d="m976 2959c-41-28-47-35-44-63 3-27 7-31 33-31 23 0 33 7 43 28 33 68 82 31 82-62 0-71-68-277-139-421-84-170-77-180 119-180 117 0 141 3 160 18 13 10 19 23 15 33-5 13-25 15-140 11-98-3-135-1-135 7 0 6 20 51 44 99s64 149 90 225c65 194 63 303-6 351-34 24-70 19-122-15z"/><path d="m5300 2971c-5-11-10-56-10-101 0-92-8-113-50-135-27-14-30-14-49 11-23 29-28 83-11 115 15 26-4 59-33 59-38 0-47-18-41-84 13-138 66-196 148-162 43 18 42 21 51-134 8-152 18-190 50-190 30 0 39 27 26 77-6 21-15 104-21 184-9 129-8 151 6 185 20 46 22 140 5 172-15 28-56 29-71 3z"/><path d="m4920 2934c-19-9-93-32-165-53-142-42-167-60-139-99 19-28 64-30 71-3 6 25 30 34 37 15 10-25 28-245 22-261-10-26 13-54 41-51 35 4 52 32 35 58-6 11-12 41-12 67 0 46-16 172-25 203-3 11 21 23 100 48 103 34 126 51 104 78-14 17-25 17-69-2z"/><path d="m2253 2878c-4-7-7-114-6-237 2-123 0-222-3-219-6 6-143 231-207 341-30 51-45 67-62 67-13 0-26-8-30-17-3-10-3-132 1-271 6-232 8-254 25-263 13-7 26-6 40 2 18 9 20 16 14 47-9 46-22 352-15 352 3 0 51-75 105-166 115-192 143-215 181-143 12 24 14 71 11 271-4 236-5 243-25 246-11 2-24-3-29-10z"/><path d="m4420 2875c-7-9-9-24-5-37s17-88 29-167c16-109 25-147 38-155s21-7 30 2 9 35-3 119c-8 60-14 135-14 168s-4 66-8 73c-11 17-52 15-67-3z"/><path d="m4098 2850c-50-34-109-113-128-174-16-50-8-151 15-196 24-49 63-88 109-112 78-40 202-7 250 68 33 50-12 74-55 28-38-41-77-57-124-51-56 6-89 31-120 91-33 66-33 126 1 194 47 95 151 157 169 102 4-11 18-28 31-37 23-14 26-14 44 2 30 27 24 50-22 84-57 42-108 42-170 1z"/><path d="m2896 2848c-3-7-7-33-11-58-3-25-39-133-80-240-63-169-71-198-60-215 30-48 75-24 73 39-1 58 16 96 44 96 13 0 50 9 82 20 33 11 60 20 61 20s14-27 30-60c31-65 44-75 71-56 16 12 16 17-14 79-18 36-32 72-32 79 0 8-7 24-16 37-9 12-35 78-58 144-35 104-44 122-64 125-12 2-24-3-26-10zm61-219 22-60-34-15c-19-8-42-11-53-6-18 7-18 9 6 75 14 37 28 67 31 67s16-27 28-61z"/><path d="m3285 2827c-51-20-104-57-110-77-3-11-2-27 3-37s15-58 22-108c14-104 30-149 58-164 16-9 24-7 37 5 14 15 14 19-5 50-12 18-20 44-18 56 5 36 69 37 120 2 47-33 118-111 118-130 0-7 8-17 17-23 21-12 53 3 53 25 0 25-86 130-135 165l-45 32 35 39c24 26 35 48 35 69 0 37-24 85-49 99-26 13-98 12-136-3zm115-62c29-35-33-106-107-121-28-5-33-3-37 17-3 13-2 40 2 59 6 28 15 37 42 47 48 16 85 16 100-2z"/><path d="m2610 2756c-20-8-75-20-124-27-95-15-113-28-97-71 5-13 12-48 15-78 10-76 43-178 72-222 22-34 29-38 68-38 32 0 54 8 84 30 46 33 50 41 27 60-13 11-23 9-54-8-55-31-69-28-91 21-11 23-20 47-20 53s26 17 58 23c53 10 102 39 102 60 0 5-7 14-16 22-13 10-20 10-42-3-25-15-63-22-103-19-11 1-19 13-23 35-8 43 1 65 28 71 11 2 46 9 76 15 31 6 70 19 88 30 28 17 31 23 22 40-12 23-21 24-70 6z"/><path d="m1336 2324c-19-18-20-28-6-55 20-37 80-15 80 30 0 14-29 41-45 41-7 0-21-7-29-16z"/><path d="m960 1432c-46-22-86-92-70-122 22-40 89-15 77 30-10 38 58 64 104 40 12-7 19-21 19-41 0-37-72-119-105-119-12 0-34-10-49-21-21-16-26-28-24-53 4-41 32-45 81-11 64 43 118 29 170-45 27-38 22-107-11-156-49-74-80-104-127-124-59-25-85-26-85-1s-26 34-45 15c-20-21-19-57 3-77 24-22 100-22 150-2 46 20 140 119 172 181 25 51 30 118 11 166-13 35-68 96-103 114l-29 15 22 30c23 33 35 94 25 134-14 57-115 83-186 47z"/><path d="m2470 1419c-51-30-61-46-48-75 6-13 17-24 23-24 8 0 14-52 19-177 4-98 7-192 6-209-1-38 21-58 54-50 30 7 36 31 19 73-18 46-18 144 1 137 25-9 154 35 198 69 24 18 51 49 62 70 17 36 17 40 1 83-30 79-111 123-230 124-54 0-78-5-105-21zm198-54c88-37 106-92 47-143-41-37-131-68-169-58l-27 7 3 104 3 105h53c29 0 69-7 90-15z"/><path d="m3380 1409c-82-33-139-164-128-293 5-66 24-95 93-148 89-67 166-73 231-16 38 34 43 53 16 67-14 7-25 4-47-15-16-13-39-27-52-30-32-9-105 30-149 78-37 41-37 41-31 111 7 86 47 174 82 183 30 7 46-2 38-22-6-16 23-54 42-54 15 0 45 33 45 49 0 20-43 72-72 87-31 16-34 16-68 3z"/><path d="m2984 1402c-6-4-30-45-52-92-37-77-58-141-97-295-7-27-16-58-19-67-8-16 24-58 43-58 25 0 42 33 36 71-7 43-17 38 107 62l67 13 18-43c19-45 33-56 58-47 19 8 19 37 1 72-31 61-89 230-102 301-16 82-31 103-60 83zm56-304c-7-9-111-30-118-24-7 8 18 106 41 160l21 49 31-89c17-49 28-92 25-96z"/><path d="m3955 1398c-22-5-77-8-122-5-93 5-106-1-102-55 1-18 1-97 0-175-2-124 1-149 18-188 15-34 29-49 55-60 73-31 152-14 195 41 26 33 26 41 1 54-16 8-25 5-50-20-23-23-40-30-69-30-55 0-82 25-88 83-7 55 7 77 48 77 49 0 128 21 151 40 21 17 22 20 7 35-14 15-22 15-51 6-19-6-59-12-89-14l-54-2-3 49c-6 93-3 96 88 96 82 0 125 12 135 38 5 14-11 43-24 41-3-1-24-5-46-11z"/><path d="m2040 1388c-47-13-70-36-70-68 0-36 7-40 119-80 99-35 142-64 166-111 32-62 9-121-60-153-48-23-148-38-199-31-35 6-42 10-42 28 1 31-42 35-72 7-29-27-28-56 3-76 42-27 233-24 305 4 127 51 170 139 121 247-29 64-91 108-207 145-59 19-61 28-10 35 37 6 51 4 66-10 41-37 95 9 63 54-12 18-24 21-81 20-37 0-83-5-102-11z"/><path d="m1338 864c-11-23-10-29 11-45 21-17 26-18 45-6 41 27 27 77-20 77-17 0-28-9-36-26z"/></g></svg>
</div>
</div>
<div class="paragraph">
<p>After that it was time for the boring stuff: looking for an apartment
that best fits my requirements.</p>
</div>
<div class="paragraph">
<p>I have a couple of friends in Lux and they all told me to look on the infamous
website <a href="https://athome.lu">AtHome.lu</a> to get an idea on the available
apartments that there are in Lux, so I did.</p>
</div>
<div class="paragraph">
<p>I don&#8217;t like doing this, so I try to make things easier by just
looking at the pictures and if the price looks ok I&#8217;ll just bookmark
the thing so that I can look at it later for comparisons.</p>
</div>
<div class="paragraph">
<p>This quickly becomes hard to do. Some agencies will publish part of the
monthly price, some of them will post the actual monthly price. Each
agency fee is different and it&#8217;s not immediately visible. The map
on the website is just awful and it won&#8217;t let me compare positions with other
apartments. Needless to say that it is pretty much impossible to choose
the right one with this messy data.</p>
</div>
<div class="paragraph">
<p>What I&#8217;d like to have is a big map with all the apartments that I like on
it and maybe a database to query apartments to show by different parameters.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see if we can scrape some data off of athome.lu!</p>
</div>
<div class="paragraph">
<p>After giving a quick look at the website I&#8217;ve found out that by selecting
the renting apartments in the Luxembourg area, links start with this URL path
<code>www.athome.lu/en/rent/apartment/luxembourg</code>, each apartment
has a unique id and the complete address for an apartment looks like this
<code>www.athome.lu/en/rent/apartment/luxembourg/id-642398588.html</code>.</p>
</div>
<div class="paragraph">
<p>This is a good start, it means that I can pretty much navigate to a specific apartment
page just by knowing its id.</p>
</div>
<div class="paragraph">
<p>If I inspect the html source of a single page, I immediately notice that there
is a <strong>HUGE</strong> json object with a lot of data in it at the bottom of the page,</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/initstate.png" alt="initstate">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see if we can find something interesting in it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/initstate_console.png" alt="initstate console">
</div>
</div>
<div class="paragraph">
<p>Cool, it seems like a big object to set up the entire page. If we look at
each sub-object of <code><em>INITIAL_STATE</em></code> we find <code>detail</code> which
seems to be our lucky card.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/detail_console.png" alt="detail console">
</div>
</div>
<div class="paragraph">
<p>Great! We don&#8217;t even have to scrape data from html, we have all the data of the
apartment in this <code><em>INITIAL_STATE</em>.detail</code> object!</p>
</div>
<div class="paragraph">
<p>How can I access that variable through code though? I don&#8217;t have a great experience with it
and I don&#8217;t write a lot of JS, but I heard that <a href="https://developers.google.com/web/tools/puppeteer/">Puppeteer</a>
is the right tool for the job. Let me try something out</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="javascript"><span class="kd">const</span> <span class="nx">puppeteer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">puppeteer</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">).</span><span class="nx">promises</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">scrape_json_data</span><span class="p">(</span><span class="nx">browser</span><span class="p">,</span> <span class="nx">link</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">newPage</span><span class="p">();</span>
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="p">{</span> <span class="nx">detail</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">__INITIAL_STATE__</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">detail</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">browser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">puppeteer</span><span class="p">.</span><span class="nx">launch</span><span class="p">({</span> <span class="na">headless</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="c1">// File where I'll save all my preferred apartments' links</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LINKS_PATH</span><span class="p">,</span> <span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">);</span>
    <span class="c1">// Read line by line</span>
    <span class="kd">const</span> <span class="nx">links</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/</span><span class="se">\r?\n</span><span class="sr">/</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">objs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">links</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">id_pattern</span> <span class="o">=</span> <span class="sr">/id-</span><span class="se">(\d</span><span class="sr">+</span><span class="se">)</span><span class="sr">/</span><span class="p">;</span>
        <span class="c1">// Take id from final part of each link</span>
        <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="nx">id_pattern</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">scraping: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">scrape_json_data</span><span class="p">(</span><span class="nx">browser</span><span class="p">,</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Remove all the superfluous data from detail obj</span>
            <span class="nx">obj</span> <span class="o">=</span> <span class="nx">clean_obj</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
            <span class="c1">// Add link to the obj, somehow it's not included in detail obj :/</span>
            <span class="nx">obj</span><span class="p">.</span><span class="nx">link</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">objs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">objs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">found</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">listingId</span><span class="p">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Save obj data to json file</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JSON_OUT</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">objs</span><span class="p">));</span>
    <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="p">})();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above will open a headless instance of chrome, go to each
apartment link that is saved in the file at <code>LINKS_PATH</code> and
spit an array of all the apartment data in a file at <code>JSON_OUT</code>.</p>
</div>
<div class="paragraph">
<p>We were lucky this time, we didn&#8217;t have to go through scraping html,
and this would have probably been the most boring part of the entire process.
The next steps will be about storing data in a database and visualizing it,
but first let&#8217;s write a <a href="https://github.com/casey/just">justfile</a>
(alternative to a Makefile) that will make our life easier when we
need to execute commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="justfile">base     := justfile_directory()
json_out := "/tmp/res.json"
links    := base + "/homes.txt"

scrape:
    LINKS_PATH={{links}} \
    JSON_OUT={{json_out}} \
    node scraper/main.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>I can now scrape data by just typing</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ just scrape</code></pre>
</div>
</div>
<div class="paragraph">
<p>I want to save all the data to a sqlite database
so that I can conveniently check, query and get
apartments info whenever I want and however I want.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s move away from js and switch to a compiled language,
Go will fit perfectly for this, it&#8217;s fast and easy to use.</p>
</div>
<div class="paragraph">
<p>The binary will parse the entire json file that the scraper created
and load each apartment to the <code>apartment</code> table in sqlite.</p>
</div>
<div class="paragraph">
<p>I didn&#8217;t show it before, but this is my final, cleaned-from-useless-stuff
<code>Apartment</code> struct with some tag annotations to read from json and load into
sqlite by using <a href="https://github.com/jmoiron/sqlx">sqlx</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="go"><span class="k">type</span> <span class="n">Apartment</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Found</span>                  <span class="kt">bool</span>      <span class="s">`json:"found,omitempty" db:"found,omitempty"`</span>
	<span class="n">ListingId</span>              <span class="kt">uint32</span>    <span class="s">`json:"listingId,omitempty" db:"listingId,omitempty"`</span>
	<span class="n">ListingAgencyReference</span> <span class="kt">string</span>    <span class="s">`json:"listingAgencyReference,omitempty" db:"listingAgencyReference,omitempty"`</span>
	<span class="n">IsSoldProperty</span>         <span class="kt">bool</span>      <span class="s">`json:"isSoldProperty,omitempty" db:"isSoldProperty,omitempty"`</span>
	<span class="n">Region</span>                 <span class="kt">string</span>    <span class="s">`json:"region,omitempty" db:"region,omitempty"`</span>
	<span class="n">CityName</span>               <span class="kt">string</span>    <span class="s">`json:"cityName,omitempty" db:"cityName,omitempty"`</span>
	<span class="n">Lon</span>                    <span class="kt">float64</span>   <span class="s">`json:"lon,omitempty" db:"lon,omitempty"`</span>
	<span class="n">Lat</span>                    <span class="kt">float64</span>   <span class="s">`json:"lat,omitempty" db:"lat,omitempty"`</span>
	<span class="n">Price</span>                  <span class="kt">int</span>       <span class="s">`json:"price,omitempty" db:"price,omitempty"`</span>
	<span class="n">ChargesPrice</span>           <span class="kt">int</span>       <span class="s">`json:"chargesPrice,omitempty" db:"chargesPrice,omitempty"`</span>
	<span class="n">Caution</span>                <span class="kt">float32</span>   <span class="s">`json:"caution,omitempty" db:"caution,omitempty"`</span>
	<span class="n">AgencyFee</span>              <span class="kt">string</span>    <span class="s">`json:"agency_fee,omitempty" db:"agency_fee,omitempty"`</span>
	<span class="n">PropertySubType</span>        <span class="kt">string</span>    <span class="s">`json:"propertySubType,omitempty" db:"propertySubType,omitempty"`</span>
	<span class="n">PublisherId</span>            <span class="kt">int</span>       <span class="s">`json:"publisher_id,omitempty" db:"publisher_id,omitempty"`</span>
	<span class="n">PublisherRemoteVisit</span>   <span class="kt">bool</span>      <span class="s">`json:"publisher_remote_visit,omitempty" db:"publisher_remote_visit,omitempty"`</span>
	<span class="n">PublisherPhone</span>         <span class="kt">string</span>    <span class="s">`json:"publisher_phone,omitempty" db:"publisher_phone,omitempty"`</span>
	<span class="n">PublisherName</span>          <span class="kt">string</span>    <span class="s">`json:"publisher_name,omitempty" db:"publisher_name,omitempty"`</span>
	<span class="n">PublisherAthomeId</span>      <span class="kt">string</span>    <span class="s">`json:"publisher_athome_id,omitempty" db:"publisher_athome_id,omitempty"`</span>
	<span class="n">PropertySurface</span>        <span class="kt">float64</span>   <span class="s">`json:"propertySurface,omitempty" db:"propertySurface,omitempty"`</span>
	<span class="n">BuildingYear</span>           <span class="kt">string</span>    <span class="s">`json:"buildingYear,omitempty" db:"buildingYear,omitempty"`</span>
	<span class="n">FloorNumber</span>            <span class="kt">string</span>    <span class="s">`json:"floorNumber,omitempty" db:"floorNumber,omitempty"`</span>
	<span class="n">BathroomsCount</span>         <span class="kt">int</span>       <span class="s">`json:"bathroomsCount,omitempty" db:"bathroomsCount,omitempty"`</span>
	<span class="n">BedroomsCount</span>          <span class="kt">int</span>       <span class="s">`json:"bedroomsCount,omitempty" db:"bedroomsCount,omitempty"`</span>
	<span class="n">BalconiesCount</span>         <span class="kt">int</span>       <span class="s">`json:"balconiesCount,omitempty" db:"balconiesCount,omitempty"`</span>
	<span class="n">CarparkCount</span>           <span class="kt">int</span>       <span class="s">`json:"carparkCount,omitempty" db:"carparkCount,omitempty"`</span>
	<span class="n">GaragesCount</span>           <span class="kt">int</span>       <span class="s">`json:"garagesCount,omitempty" db:"garagesCount,omitempty"`</span>
	<span class="n">HasLivingRoom</span>          <span class="kt">bool</span>      <span class="s">`json:"hasLivingRoom,omitempty" db:"hasLivingRoom,omitempty"`</span>
	<span class="n">HasKitchen</span>             <span class="kt">bool</span>      <span class="s">`json:"hasKitchen,omitempty" db:"hasKitchen,omitempty"`</span>
	<span class="n">Availability</span>           <span class="kt">string</span>    <span class="s">`json:"availability,omitempty" db:"availability,omitempty"`</span>
	<span class="n">Media</span>                  <span class="o">*</span><span class="p">[]</span><span class="kt">string</span> <span class="s">`json:"media,omitempty" db:"media,omitempty"`</span>
	<span class="n">Description</span>            <span class="kt">string</span>    <span class="s">`json:"description,omitempty" db:"description,omitempty"`</span>
	<span class="n">Link</span>                   <span class="kt">string</span>    <span class="s">`json:"link,omitempty" db:"link,omitempty"`</span>
	<span class="n">CreatedAt</span>              <span class="kt">string</span>    <span class="s">`json:"createdAt,omitempty" db:"createdAt,omitempty"`</span>
	<span class="n">UpdatedAt</span>              <span class="kt">string</span>    <span class="s">`json:"updatedAt,omitempty" db:"updatedAt,omitempty"`</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I might change my mind later down the road on the data that I want to keep
in each <code>Apartment</code> struct, so I might want to make changes to the database structure,
and therefore the queries to insert and update the database too. To make this a bit more
flexible I will use a yaml file to save any database migration and insert/update
queries to the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">migrations</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">CREATE TABLE IF NOT EXISTS apartment(</span>
      <span class="s">found BOOL,</span>
      <span class="s">listingId INTEGER PRIMARY KEY,</span>
      <span class="s">...</span>
      <span class="s">description TEXT,</span>
      <span class="s">link TEXT,</span>
      <span class="s">createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
      <span class="s">updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
  <span class="s">);</span>


<span class="na">insertQuery</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">INSERT INTO apartment(found,listingId,listingAgencyReference,isSoldProperty,region,cityName,</span>
                          <span class="s">lon,lat,price,chargesPrice,caution,agency_fee,propertySubType,publisher_id,</span>
                          <span class="s">publisher_remote_visit,publisher_phone,publisher_name,publisher_athome_id,</span>
                          <span class="s">propertySurface,buildingYear,floorNumber,bathroomsCount,bedroomsCount,balconiesCount,</span>
                          <span class="s">garagesCount,carparkCount,hasLivingRoom,hasKitchen,availability,media,description,link)</span>
    <span class="s">VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)</span>


<span class="na">updateQuery</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">UPDATE apartment</span>
    <span class="s">SET found = ?, listingId = ?, listingAgencyReference = ?, isSoldProperty = ?, region = ?, cityName = ?, lon = ?, lat = ?, price = ?,</span>
        <span class="s">chargesPrice = ?, caution = ?, agency_fee = ?, propertySubType = ?, publisher_id = ?, publisher_remote_visit = ?, publisher_phone = ?,</span>
        <span class="s">publisher_name = ?, publisher_athome_id = ?, propertySurface = ?, buildingYear = ?, floorNumber = ?, bathroomsCount = ?,</span>
        <span class="s">bedroomsCount = ?, balconiesCount = ?, garagesCount = ?, carparkCount = ?, hasLivingRoom = ?, hasKitchen = ?,</span>
        <span class="s">availability = ?, media = ?, description = ?, link = ?, updatedAt = CURRENT_TIMESTAMP</span>
    <span class="s">WHERE listingId = ?</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After setting up these basic features and with a little more code
I can compile the program and run it so that it will load the previous
json file into my sqlite <code>apartment</code> table.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add some more commands to the justfile that we&#8217;ve
created previously.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="justfile">db_path  := base + "/db.sqlite"

gobuild:
    cd {{base}}/loader; go build cmd/main.go

load: gobuild
    CONFIG_PATH={{base}}/loader/config.yaml \
    JSON_OUT={{json_out}} \
    DB_PATH={{db_path}} \
    {{base}}/loader/main

fetch: scrape load</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s load the data into database</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ just load
&gt; OR
$ just fetch
&gt; which will first scrape data and then load it in the database
&gt; justfiles are cool!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to get some specs, this runs fast. Take a look</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ cat home.txt | wc
  65      66    4469
$ time just load
just load  0.38s user 0.52s system 220% cpu 0.408 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>I now have all the data that I scraped in my nice and super fast
database, ready to be queried with the craziest query that comes
to my mind, I can think of some.</p>
</div>
<div class="paragraph">
<p>We&#8217;re at a going point at the moment, I have a lot of parameters
with which I can query apartments that I like. I can select them by
non-decreasing price, by area and if I add some more complex Haversine
formulae I could also sort them by distance from the city centre or any
other map coordinates.</p>
</div>
<div class="paragraph">
<p>I won&#8217;t stop here though. I have some interesting little vars in
each apartment data: <code>lat</code>, <code>lon</code>. I don&#8217;t want to waste geo data!
It&#8217;s nice and fun to just look at tabular data, but I think I could
get an easier idea of the location just by plotting stuff on a map.</p>
</div>
<div class="paragraph">
<p>I want to code something quick with the smallest amount of code, so I&#8217;ll
go with Python and Jupyter notebook in conjunction with
<a href="https://python-visualization.github.io/folium/">Folium</a> which is
a library that generates <a href="https://leafletjs.com/">Leaflet</a> maps.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s setup the map with my point of interest</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">lux_coords</span> <span class="o">=</span> <span class="p">[</span><span class="mf">49.611622</span><span class="p">,</span> <span class="mf">6.131935</span><span class="p">]</span>
<span class="n">map_</span> <span class="o">=</span> <span class="n">folium</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">lux_coords</span><span class="p">,</span> <span class="n">zoom_start</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">interesting_coords</span> <span class="o">=</span> <span class="p">[</span><span class="mf">49.630033</span><span class="p">,</span> <span class="mf">6.168936</span><span class="p">]</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">popup</span><span class="o">=</span><span class="s">"Point of interest"</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="p">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">)).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>

<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'green'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'yellow'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'orange'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will show a map centered on Lux, with a cool red pin on my point of interest
and to get a better idea of the distance, I also added some circles with a radius of
5km, 10km, 15km and 20km. This is extremely useful because I can discard immediately
by looking at the map of apartments that are too far from my point of interest.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/poi.png" alt="poi">
</div>
</div>
<div class="paragraph">
<p>Before going crazy with SQL I need to add my scraped apartments
to the map and for the sake of simplicity I will query them all here</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="k">def</span> <span class="nf">getApartments</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">"""
        SELECT *
        FROM apartment
        WHERE
            found = TRUE
        """</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">Apartment</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">addApartment</span><span class="p">(</span><span class="n">map_</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">popup</span> <span class="o">=</span> <span class="n">folium</span><span class="p">.</span><span class="n">Popup</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">_popup_</span><span class="p">(),</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">450</span><span class="p">)</span>
    <span class="n">folium</span><span class="p">.</span><span class="n">Marker</span><span class="p">(</span>
        <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">lon</span><span class="p">],</span>
        <span class="n">popup</span><span class="o">=</span><span class="n">popup</span><span class="p">,</span>
        <span class="c1"># I can use fontawesome to change the pin icon
</span>        <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="p">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">a</span><span class="p">.</span><span class="n">_get_color</span><span class="p">(),</span> <span class="n">icon</span><span class="o">=</span><span class="n">a</span><span class="p">.</span><span class="n">_get_icon</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s">"fa"</span><span class="p">)</span>
    <span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>


<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"DB_PATH"</span><span class="p">])</span>
<span class="n">apartments</span> <span class="o">=</span> <span class="n">getApartments</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apartments</span><span class="p">:</span>
    <span class="n">addApartment</span><span class="p">(</span><span class="n">map_</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="n">map_</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/poi_apartments.png" alt="poi apartments">
</div>
</div>
<div class="paragraph">
<p>And here we have it! Definitely a much better experience
than going back and forth on the website and drawing on a map
all the apartments one by one, right?</p>
</div>
<div class="paragraph">
<p>In the code above you can see that I&#8217;ve used a custom popup for each
apartment. With Folium we can use HTML to customize the pin&#8217;s popup
with the most important information I want to see (i.e. monthly total price, initial fee,
caution etc.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="k">def</span> <span class="nf">_popup_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">"""
    &lt;h4&gt;Info&lt;/h4&gt;
    &lt;b&gt;ID: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">listingId</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Monthly Price: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">price</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Monthly Charge: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">chargesPrice</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Caution: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">caution</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Agency Fee: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">agencyFee</span><span class="si">}</span><span class="s">
    &lt;br&gt;
    &lt;h4&gt;Total&lt;/h4&gt;
    &lt;b&gt;Monthly: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">price</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">chargesPrice</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Initial: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">caution</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">agencyFee</span><span class="si">}</span><span class="s">&lt;br&gt;&lt;br&gt;
    &lt;a href="</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">link</span><span class="si">}</span><span class="s">" target="_blank"&gt;Page&lt;/a&gt;&lt;br&gt;
    &lt;a href="</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">galleryLink</span><span class="si">}</span><span class="s">" target="_blank"&gt;Gallery&lt;/a&gt;&lt;br&gt;
    """</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/popup.png" alt="popup">
</div>
</div>
<div class="paragraph">
<p>That&#8217;s just what I wanted, I can now see on the map which are the best
located apartments in Lux and immediately get to see the info that I&#8217;m
interested in the most!</p>
</div>
<div class="paragraph">
<p>Why would I save the data on a database if I don&#8217;t use SQL at all?
Let&#8217;s say that I have a base budget of 1000€ and I want to show only
the apartments on which I would have to spend an incremental amount of 200€,
I could simply change the SQL query to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">apartment</span>
<span class="k">WHERE</span>
    <span class="k">found</span> <span class="o">=</span> <span class="k">TRUE</span> <span class="k">AND</span>
    <span class="n">listingId</span> <span class="k">IN</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">listingId</span>
        <span class="k">FROM</span> <span class="n">apartment</span>
        <span class="k">WHERE</span>
            <span class="k">found</span> <span class="o">=</span> <span class="k">TRUE</span> <span class="k">AND</span>
            <span class="n">price</span> <span class="o">+</span> <span class="n">chargesPrice</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">200</span>
    <span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Phewww, if you&#8217;re still here reading all this you deserve a bonus point.</p>
</div>
<div class="paragraph">
<p>Imagine I saw a very cool apartment that looks like a very good deal but
it&#8217;s a bit out of the city, what&#8217;s the best way to know how much it is going
to take me to get from that apartment to my point of interest with public transportation?</p>
</div>
<div class="paragraph">
<p>If you paid close attention to the image above you might already know the answer,
Google Maps of course! Google Maps is very cool, you can get directions from
position x to position y by visiting <code>www.google.com/maps/dir/x.lat,x.lon/y.lat,y.lon</code>.</p>
</div>
<div class="paragraph">
<p>All I need to do is add <code>&lt;a href="{self.mapsDir}" target="_blank"&gt;Maps Directions&lt;/a&gt;</code>
to the popup dialog I pasted above and I will have a very handy link that
will open Google Maps on a new tab with the time travel from position x to y.</p>
</div>
<div class="paragraph">
<p>This will save me so much time, you have no idea!</p>
</div>
<div class="paragraph">
<p>Why don&#8217;t we finish this by completing our justfile? In the end I
want to type a single command and be shown the map with all the apartments
that I saved on my file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="justfile">open:
    DB_PATH={{db_path}} \
    jupyter notebook \
    {{base}}/analyzer/apartments.ipynb

show: fetch open</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is so convenient, I can finally only look at pictures of cool
apartments, save the link on my file and at the end of the day type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ just show</code></pre>
</div>
</div>
<div class="paragraph">
<p>Life is good now, at least I made the process funnier and more efficient
than before!</p>
</div>
<div class="paragraph">
<p>The only thing that is <em>very slow</em> at the moment is the first js snippet,
it takes ~1s to get a single apartment, multiply
that for 100 apartments and you will have to wait for a couple of minutes before
seeing all the pins on the map. The immediate solution would be to make multiple
page requests at a time but I&#8217;m not much of an expert with `Promise`s so I think
I&#8217;ll stick with this solution until I&#8217;m not bored again to wait
for the tool to scrape each link.</p>
</div>
<div class="paragraph">
<p>I now need to get back to hunting that apartment, wish me luck!</p>
</div>
</article>
<script>
    function renderCodeTags() {
        const collection = document.getElementsByClassName("rouge highlight");

        for (let i = 0; i < collection.length; i++) {
        let cNode = collection[i].firstChild;
        let lang = cNode.getAttribute("data-lang");
        
        let newNode = document.createElement("div");
        newNode.className = "lang-tag";
        newNode.innerHTML += lang;
        
        collection[i].insertBefore(newNode, cNode);
        }
    }

    renderCodeTags()
</script>
    </main>

    <footer class="site-footer">
        <p>
            <a href=" /feed.xml">
                <i class="fa fa-rss"></i> rss
            </a>

            <a href="https://github.com/mattrighetti">
                <i class="fa fa-github"></i> mattrighetti
            </a>
        </p>
    </footer>

</body>

</html>